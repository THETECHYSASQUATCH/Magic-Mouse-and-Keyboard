// AppleMagicFilter.h - Apple Magic Mouse/Keyboard upper filter (kernel-mode)
// Kernel-mode only version (NO_WDK stub removed)
#pragma once
#include <ntddk.h>
#include <wdf.h>
#include <hidport.h>

// {7B6E6F2F-4D2F-4A43-B5B2-9D7CB5A0B9E1}
DEFINE_GUID(GUID_DEVINTERFACE_RECOMPILED_RAW,
0x7b6e6f2f,0x4d2f,0x4a43,0xb5,0xb2,0x9d,0x7c,0xb5,0xa0,0xb9,0xe1);

#define RECOMPILED_MAX_REPORT_SIZE 64
#define RECOMPILED_RING_CAPACITY     64

// Parsed Magic Mouse contact (simplified)
typedef struct _MAGIC_CONTACT {
    UCHAR  ContactId;
    USHORT X; // raw coordinate
    USHORT Y;
    UCHAR  TouchMajor;
    UCHAR  TouchMinor;
    BOOLEAN Valid;
} MAGIC_CONTACT, *PMAGIC_CONTACT;

typedef struct _MAGIC_PARSED_MOUSE_REPORT {
    UCHAR ReportId;
    UCHAR Buttons;
    SHORT DeltaX;
    SHORT DeltaY;
    UCHAR ContactCount;
    MAGIC_CONTACT Contacts[MAGIC_MAX_CONTACTS];
} MAGIC_PARSED_MOUSE_REPORT, *PMAGIC_PARSED_MOUSE_REPORT;

// Ring buffer for raw reports (single-producer in completion, multi-consumer via IOCTL)
typedef struct _RECOMPILED_REPORT_RING {
    UCHAR  Data[RECOMPILED_RING_CAPACITY][RECOMPILED_MAX_REPORT_SIZE];
    USHORT Lengths[RECOMPILED_RING_CAPACITY];
    volatile LONG Head;
    WDFSPINLOCK Lock;
} RECOMPILED_REPORT_RING, *PRECOMPILED_REPORT_RING;

typedef struct _DEVICE_CONTEXT {
    WDFDEVICE Device;
    WDFQUEUE  Queue;
    RECOMPILED_REPORT_RING Ring;
} DEVICE_CONTEXT, *PDEVICE_CONTEXT;

WDF_DECLARE_CONTEXT_TYPE_WITH_NAME(DEVICE_CONTEXT, GetDeviceContext);

DRIVER_INITIALIZE DriverEntry;
EVT_WDF_DRIVER_DEVICE_ADD Recompiled_EvtDeviceAdd;
EVT_WDF_DEVICE_PREPARE_HARDWARE Recompiled_EvtPrepareHardware;
EVT_WDF_IO_QUEUE_IO_INTERNAL_DEVICE_CONTROL Recompiled_EvtIoInternalDeviceControl;
EVT_WDF_IO_QUEUE_IO_DEVICE_CONTROL Recompiled_EvtIoDeviceControl;
EVT_WDF_REQUEST_COMPLETION_ROUTINE Recompiled_ReadReportCompletion;

#define IOCTL_RECOMPILED_GET_LAST CTL_CODE(FILE_DEVICE_KEYBOARD, 0x900, METHOD_BUFFERED, FILE_ANY_ACCESS)
